<?xml version="1.0" encoding="utf-8" ?>
<local:BaseContentPage
    x:Class="VisitTracker.IncidentReportPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:domain="clr-namespace:VisitTracker.Domain;assembly=VisitTracker.Domain"
    xmlns:input="clr-namespace:InputKit.Shared.Controls;assembly=InputKit.Maui"
    xmlns:local="clr-namespace:VisitTracker"
    xmlns:m="clr-namespace:UraniumUI.Icons.MaterialIcons;assembly=UraniumUI.Icons.MaterialIcons"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
    xmlns:validation="clr-namespace:InputKit.Shared.Validations;assembly=InputKit.Maui"
    x:Name="this"
    Title="Incident Report"
    x:DataType="local:IncidentReportVm"
    x:TypeArguments="local:IncidentReportVm"
    BackgroundColor="{StaticResource MainBackgroudColor}"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False">
    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding OnBackCommand}" />
    </Shell.BackButtonBehavior>
    <ContentPage.ToolbarItems>
        <ToolbarItem
            AutomationId="EditButton"
            Command="{Binding OpenDeleteConfirmationCommand}"
            IconImageSource="{Binding ToolbarIconSource}"
            IsEnabled="{Binding IsNotReadOnly}"
            Text="Delete" />
    </ContentPage.ToolbarItems>
    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="SubTitleLabel" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="18" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Margin="0,10" RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0" IsVisible="{Binding IsNotBusy}">
            <input:FormView
                Margin="10,0"
                IsVisible="{Binding IsNotBusy}"
                Spacing="10"
                SubmitCommand="{Binding SubmitCommand}">
                <VerticalStackLayout Spacing="15">
                    <ScrollView IsVisible="{Binding IsNotReadOnly}" Orientation="Horizontal">
                        <HorizontalStackLayout Spacing="8">
                            <local:EmergencyButtonControl />
                            <local:CallOfficeButtonControl />
                        </HorizontalStackLayout>
                    </ScrollView>

                    <local:CardViewControl HasCardTitle="False" IsVisible="{Binding ServiceUser, Converter={StaticResource IsNotNullConverter}}">
                        <local:UserCardControl Padding="5" User="{Binding ServiceUserCard}" />
                    </local:CardViewControl>

                    <material:InputField
                        Title="Incident Location *"
                        HasValue="True"
                        IsEnabled="{Binding IsNotReadOnly}"
                        IsVisible="{Binding ServiceUser, Converter={StaticResource IsNotNullConverter}}"
                        Style="{StaticResource MaterialInputField}">
                        <VerticalStackLayout
                            Margin="5"
                            Padding="5"
                            Spacing="5">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    Grid.Column="0"
                                    FontSize="16"
                                    HorizontalOptions="Start"
                                    HorizontalTextAlignment="Start"
                                    Text="Same as above"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center" />

                                <HorizontalStackLayout
                                    Grid.Column="1"
                                    BackgroundColor="Transparent"
                                    Spacing="10">
                                    <material:RadioButton
                                        AutomationId="AtSuLocationYes"
                                        BackgroundColor="Transparent"
                                        ClickCommand="{Binding ChangeLocationCommand}"
                                        IsChecked="{Binding AtSuLocation}"
                                        IsDisabled="{Binding IsReadOnly}"
                                        LabelPosition="After"
                                        Text="Yes"
                                        TextColor="{StaticResource TextColor}"
                                        VerticalOptions="Center" />

                                    <material:RadioButton
                                        AutomationId="AtSuLocationNo"
                                        BackgroundColor="Transparent"
                                        ClickCommand="{Binding ChangeLocationCommand}"
                                        IsChecked="{Binding AtSuLocation, Converter={x:StaticResource NotConverter}}"
                                        IsDisabled="{Binding IsReadOnly}"
                                        LabelPosition="After"
                                        Text="No"
                                        TextColor="{StaticResource TextColor}"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>

                            <material:TextField
                                Title="Enter location details"
                                Margin="0,0,0,0"
                                AutomationId="LocationDetails"
                                IsReadOnly="{Binding IsReadOnly}"
                                IsVisible="{Binding Incident.AtSuLocation, Converter={x:StaticResource NotConverter}}"
                                Style="{StaticResource MaterialTextField}"
                                Text="{Binding Incident.Location}" />

                            <Grid IsVisible="{Binding Incident.AtSuLocation}">
                                <Label
                                    FontSize="14"
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding Incident.Location, Converter={StaticResource IsStringNotNullOrEmptyConverter}}"
                                    Text="{Binding Incident.Location}"
                                    TextColor="{StaticResource TextColor}" />

                                <Label
                                    FontSize="14"
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding Incident.Location, Converter={StaticResource IsStringNullOrEmptyConverter}}"
                                    Style="{StaticResource MutedTextStyles}"
                                    Text="(address information not available)" />
                            </Grid>
                        </VerticalStackLayout>
                    </material:InputField>

                    <material:InputField
                        Title="Incident Date &amp; Time"
                        HasValue="True"
                        IsEnabled="{Binding IsNotReadOnly}"
                        Style="{StaticResource MaterialInputField}">
                        <Grid Margin="5" ColumnDefinitions="*,*">
                            <DatePicker
                                Grid.Column="0"
                                BackgroundColor="Transparent"
                                Date="{Binding IncidentDate, Mode=TwoWay}"
                                FontSize="14"
                                Format="dd/MM/yyyy"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding IsNotReadOnly}"
                                TextColor="{StaticResource TextColor}" />
                            <HorizontalStackLayout Grid.Column="1" HorizontalOptions="Center">
                                <Border
                                    Padding="0"
                                    BackgroundColor="Transparent"
                                    StrokeThickness="0">
                                    <TimePicker
                                        BackgroundColor="Transparent"
                                        FontSize="14"
                                        Format="HH:mm"
                                        HorizontalOptions="Center"
                                        IsEnabled="{Binding IsNotReadOnly}"
                                        TextColor="{StaticResource TextColor}"
                                        Time="{Binding IncidentTime, Mode=TwoWay}" />
                                </Border>
                                <Label
                                    Margin="0,0,0,2"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    Text="hrs"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Grid>
                    </material:InputField>

                    <VerticalStackLayout Margin="0,5">
                        <material:PickerField
                            Title="Incident Type *"
                            AllowClear="{Binding IsNotReadOnly}"
                            AutomationId="IncidentType"
                            IsEnabled="{Binding IsNotReadOnly}"
                            ItemDisplayBinding="{Binding DisplayName, x:DataType=domain:Code}"
                            ItemsSource="{Binding TypeList}"
                            SelectedItem="{Binding SelectedType, Mode=TwoWay}"
                            SelectedValueChangedCommand="{Binding OtherChangeCommand}"
                            Style="{StaticResource MaterialPickerField}" />

                        <material:TextField
                            Title="Please specify"
                            HorizontalOptions="Fill"
                            IsEnabled="{Binding IsNotReadOnly}"
                            IsReadOnly="{Binding IsReadOnly}"
                            IsVisible="{Binding IsTypeOther, Mode=TwoWay}"
                            Text="{Binding Incident.OtherIncidentType, Mode=TwoWay}"
                            VerticalOptions="Fill" />
                    </VerticalStackLayout>

                    <VerticalStackLayout Margin="0,5">
                        <material:PickerField
                            Title="Injury *"
                            AllowClear="{Binding IsNotReadOnly}"
                            AutomationId="Injury"
                            IsEnabled="{Binding IsNotReadOnly}"
                            ItemDisplayBinding="{Binding DisplayName, x:DataType=domain:Code}"
                            ItemsSource="{Binding InjuryList}"
                            SelectedItem="{Binding SelectedInjury, Mode=TwoWay}"
                            SelectedValueChangedCommand="{Binding OtherChangeCommand}"
                            Style="{StaticResource MaterialPickerField}" />

                        <material:TextField
                            Title="Please specify"
                            HorizontalOptions="Fill"
                            IsEnabled="{Binding IsNotReadOnly}"
                            IsReadOnly="{Binding IsReadOnly}"
                            IsVisible="{Binding IsInjuryOther, Mode=TwoWay}"
                            Style="{StaticResource MaterialTextField}"
                            Text="{Binding Incident.OtherInjury, Mode=TwoWay}"
                            VerticalOptions="Fill" />
                    </VerticalStackLayout>

                    <material:PickerField
                        Title="Treatment *"
                        Margin="0,5"
                        AllowClear="{Binding IsNotReadOnly}"
                        AutomationId="Treatment"
                        IsEnabled="{Binding IsNotReadOnly}"
                        ItemDisplayBinding="{Binding DisplayName, x:DataType=domain:Code}"
                        ItemsSource="{Binding TreatmentList}"
                        SelectedItem="{Binding SelectedTreatment, Mode=TwoWay}"
                        Style="{StaticResource MaterialPickerField}" />

                    <material:EditorField
                        Title="Notes *"
                        AutomationId="Notes"
                        IsEnabled="{Binding IsNotReadOnly}"
                        IsReadOnly="{Binding IsReadOnly}"
                        MaxLength="2000"
                        Style="{StaticResource MaterialEditorField}"
                        Text="{Binding Incident.Summary}" />

                    <StackLayout IsVisible="{Binding IsReadOnly}" VerticalOptions="Center">
                        <Grid ColumnDefinitions="100,*" ColumnSpacing="15">
                            <Label
                                Grid.Column="0"
                                Margin="0,5,0,0"
                                HorizontalOptions="Start"
                                Style="{StaticResource Heading1Style}"
                                Text="Attachments:"
                                VerticalOptions="Center" />

                            <local:HorizontalAttachmentControl
                                Grid.Column="1"
                                AttachmentList="{Binding AttachmentList}"
                                BaseVisitId="{Binding BaseVisitId}"
                                Type="{Binding TypeName}"
                                TypeId="{Binding Incident.Id}"
                                VerticalOptions="Start" />
                        </Grid>
                    </StackLayout>

                    <StackLayout IsVisible="{Binding IsReadOnly}">
                        <Grid ColumnDefinitions="100,*" ColumnSpacing="15">
                            <Label
                                Grid.Column="0"
                                Margin="0,5,0,0"
                                HorizontalOptions="Start"
                                Style="{StaticResource Heading1Style}"
                                Text="Body Maps:"
                                VerticalOptions="Center" />

                            <local:HorizontalBodyMapControl
                                Grid.Column="1"
                                BaseVisitId="{Binding BaseVisitId}"
                                BodyMapList="{Binding BodyMapList, Mode=TwoWay}"
                                IsReadOnly="True"
                                Type="{Binding TypeName}"
                                TypeId="{Binding Incident.Id}"
                                VerticalOptions="Center" />
                        </Grid>
                    </StackLayout>

                    <Border
                        Padding="8"
                        IsVisible="{Binding IsReadOnly, Converter={StaticResource NotConverter}}"
                        Stroke="SlateGray"
                        StrokeShape="{RoundRectangle CornerRadius=10}">
                        <material:TabView>
                            <material:TabItem Title="Attachments">
                                <material:TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <material:ButtonView TappedCommand="{Binding Command}">
                                            <Label
                                                FontFamily="13"
                                                HorizontalOptions="Center"
                                                Text="Attachments"
                                                TextColor="{StaticResource TextColor}" />
                                            <material:ButtonView.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="True">
                                                    <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="False">
                                                    <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                </DataTrigger>
                                            </material:ButtonView.Triggers>
                                        </material:ButtonView>
                                    </DataTemplate>
                                </material:TabItem.HeaderTemplate>
                                <material:TabItem.Content>
                                    <local:AttachmentControl
                                        Padding="5"
                                        AttachmentList="{Binding AttachmentList, Mode=TwoWay}"
                                        BaseVisitId="{Binding BaseVisitId}"
                                        IsReadOnly="{Binding IsReadOnly}"
                                        MaxAudios="3"
                                        MaxImages="3"
                                        Type="{Binding TypeName}"
                                        TypeId="{Binding Incident.Id}" />
                                </material:TabItem.Content>
                            </material:TabItem>

                            <material:TabItem Title="Body Maps">
                                <material:TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <material:ButtonView TappedCommand="{Binding Command}">
                                            <Label
                                                FontFamily="13"
                                                HorizontalOptions="Center"
                                                Text="Body Maps"
                                                TextColor="{StaticResource TextColor}"
                                                VerticalOptions="Center" />
                                            <material:ButtonView.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="True">
                                                    <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="False">
                                                    <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                </DataTrigger>
                                            </material:ButtonView.Triggers>
                                        </material:ButtonView>
                                    </DataTemplate>
                                </material:TabItem.HeaderTemplate>
                                <material:TabItem.Content>
                                    <local:BodyMapControl
                                        BaseVisitId="{Binding BaseVisitId}"
                                        BodyMapList="{Binding BodyMapList, Mode=TwoWay}"
                                        IsReadOnly="{Binding IsReadOnly}"
                                        Type="{Binding TypeName}"
                                        TypeId="{Binding Incident.Id}" />
                                </material:TabItem.Content>
                            </material:TabItem>
                        </material:TabView>
                    </Border>
                </VerticalStackLayout>
            </input:FormView>
        </ScrollView>

        <input:FormView
            Grid.Row="1"
            Margin="10,0"
            IsVisible="{Binding IsNotBusy}"
            Spacing="10"
            SubmitCommand="{Binding SubmitCommand}"
            VerticalOptions="Fill">
            <material:ButtonView
                Grid.Row="1"
                input:FormView.IsSubmitButton="True"
                AutomationId="Save"
                IsEnabled="{Binding IsNotBusy}"
                IsVisible="{Binding IsNotReadOnly}"
                Style="{StaticResource CentralizedButtonViewStyle}">
                <Grid>
                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        IsVisible="{Binding IsNotBusy}"
                        Spacing="10">
                        <Label Style="{StaticResource CentralizedPrimaryBtnLabelStyle}" Text="SAVE" />
                    </HorizontalStackLayout>

                    <local:CustomActivityIndicator
                        BusyText="Saving..."
                        IsBusy="{Binding IsBusy}"
                        SourceFile="LoaderWhite.json"
                        Style="{StaticResource CentralizedActivityIndicatorStyle}" />
                </Grid>
            </material:ButtonView>

        </input:FormView>

        <local:CustomActivityIndicator IsBusy="{Binding IsBusy}" />
    </Grid>
</local:BaseContentPage>