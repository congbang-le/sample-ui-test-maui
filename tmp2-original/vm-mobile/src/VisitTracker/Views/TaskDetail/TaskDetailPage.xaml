<?xml version="1.0" encoding="utf-8" ?>
<local:BaseContentPage
    x:Class="VisitTracker.TaskDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:domain="clr-namespace:VisitTracker.Domain;assembly=VisitTracker.Domain"
    xmlns:input="clr-namespace:InputKit.Shared.Controls;assembly=InputKit.Maui"
    xmlns:local="clr-namespace:VisitTracker"
    xmlns:m="clr-namespace:UraniumUI.Icons.MaterialIcons;assembly=UraniumUI.Icons.MaterialIcons"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
    xmlns:validation="clr-namespace:InputKit.Shared.Validations;assembly=InputKit.Maui"
    Title="Task Details"
    x:DataType="local:TaskDetailVm"
    x:TypeArguments="local:TaskDetailVm"
    BackgroundColor="{StaticResource MainBackgroudColor}"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False">
    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding OnBackCommand}" />
    </Shell.BackButtonBehavior>

    <Grid Margin="0,10" RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <input:FormView
                Margin="10,0"
                IsVisible="{Binding IsNotBusy}"
                Spacing="10"
                SubmitCommand="{Binding SubmitCommand}"
                VerticalOptions="Fill">
                <VerticalStackLayout Spacing="15">

                    <local:CardViewControl HasCardTitle="False">
                        <local:UserCardControl Padding="5" User="{Binding ServiceUserCard}" />
                    </local:CardViewControl>

                    <!--  main  -->
                    <material:InputField
                        Title="Task"
                        HasValue="True"
                        IsEnabled="{Binding IsNotReadOnly}"
                        Style="{StaticResource MaterialInputField}">
                        <Label
                            Padding="10"
                            FontSize="14"
                            HorizontalOptions="Fill"
                            HorizontalTextAlignment="Start"
                            Text="{Binding Task.Title}"
                            TextColor="{StaticResource TextColor}"
                            VerticalOptions="Center"
                            VerticalTextAlignment="Center" />
                    </material:InputField>
                    <!--  main  -->

                    <material:PickerField
                        Title="Completion Status *"
                        Margin="0,5"
                        AutomationId="CompletionStatus"
                        IsEnabled="{Binding IsNotReadOnly}"
                        IsVisible="{Binding IsNotReadOnly}"
                        ItemDisplayBinding="{Binding DisplayName, x:DataType=domain:Code}"
                        ItemsSource="{Binding StatusList}"
                        SelectedItem="{Binding SelectedStatus, Mode=TwoWay}"
                        Style="{StaticResource PickerFieldStyle}">
                        <validation:RequiredValidation Message="* required" />
                    </material:PickerField>

                    <material:EditorField
                        Title="Completion Status"
                        IsEnabled="{Binding IsNotReadOnly}"
                        IsReadOnly="{Binding IsReadOnly}"
                        IsVisible="{Binding IsReadOnly}"
                        MaxLength="2000"
                        Style="{StaticResource MaterialEditorField}"
                        Text="{Binding SelectedStatus.Name}">
                        <!--<validation:RequiredValidation Message="* required" />-->
                    </material:EditorField>

                    <material:EditorField
                        Title="Notes"
                        AutomationId="Notes"
                        IsEnabled="{Binding IsNotReadOnly}"
                        IsReadOnly="{Binding IsReadOnly}"
                        MaxLength="2000"
                        Style="{StaticResource MaterialEditorField}"
                        Text="{Binding VisitTask.Summary}">
                        <!--<validation:RequiredValidation Message="* required" />-->
                    </material:EditorField>

                    <StackLayout IsVisible="{Binding IsReadOnly}">
                        <Grid ColumnDefinitions="100,*" ColumnSpacing="15">
                            <Label
                                Grid.Column="0"
                                Margin="0,5,0,0"
                                HorizontalOptions="Start"
                                Style="{StaticResource Heading1Style}"
                                Text="Attachments:"
                                VerticalOptions="Center" />

                            <local:HorizontalAttachmentControl
                                Grid.Column="1"
                                AttachmentList="{Binding AttachmentList, Mode=TwoWay}"
                                BaseVisitId="{Binding BaseVisitId}"
                                Type="{Binding TypeName}"
                                TypeId="{Binding VisitTask.Id}"
                                VerticalOptions="Start" />
                        </Grid>
                    </StackLayout>

                    <StackLayout IsVisible="{Binding IsReadOnly}">
                        <Grid ColumnDefinitions="100,*" ColumnSpacing="15">
                            <Label
                                Grid.Column="0"
                                Margin="0,5,0,0"
                                HorizontalOptions="Start"
                                Style="{StaticResource Heading1Style}"
                                Text="Body Maps:"
                                VerticalOptions="Center" />

                            <local:HorizontalBodyMapControl
                                Grid.Column="1"
                                BaseVisitId="{Binding BaseVisitId}"
                                BodyMapList="{Binding BodyMapList, Mode=TwoWay}"
                                IsReadOnly="True"
                                Type="{Binding TypeName}"
                                TypeId="{Binding VisitTask.Id}"
                                VerticalOptions="Center" />
                        </Grid>
                    </StackLayout>

                    <Border
                        Padding="8"
                        IsVisible="{Binding IsReadOnly, Converter={StaticResource NotConverter}}"
                        Stroke="SlateGray"
                        StrokeShape="{RoundRectangle CornerRadius=10}">
                        <material:TabView>
                            <material:TabItem Title="Attachments">
                                <material:TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <material:ButtonView TappedCommand="{Binding Command}">
                                            <Label
                                                FontFamily="13"
                                                HorizontalOptions="Center"
                                                Text="Attachments"
                                                TextColor="{StaticResource TextColor}" />
                                            <material:ButtonView.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="True">
                                                    <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="False">
                                                    <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                </DataTrigger>
                                            </material:ButtonView.Triggers>
                                        </material:ButtonView>
                                    </DataTemplate>
                                </material:TabItem.HeaderTemplate>
                                <material:TabItem.Content>
                                    <local:AttachmentControl
                                        Padding="5"
                                        AttachmentList="{Binding AttachmentList, Mode=TwoWay}"
                                        BaseVisitId="{Binding BaseVisitId}"
                                        IsReadOnly="{Binding IsReadOnly}"
                                        MaxAudios="3"
                                        MaxImages="3"
                                        Type="{Binding TypeName}"
                                        TypeId="{Binding VisitTask.Id}" />
                                </material:TabItem.Content>
                            </material:TabItem>

                            <material:TabItem Title="Body Maps">
                                <material:TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <material:ButtonView TappedCommand="{Binding Command}">
                                            <Label
                                                FontFamily="13"
                                                HorizontalOptions="Center"
                                                Text="Body Maps"
                                                TextColor="{StaticResource TextColor}"
                                                VerticalOptions="Center" />
                                            <material:ButtonView.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="True">
                                                    <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsSelected}"
                                                    TargetType="material:ButtonView"
                                                    Value="False">
                                                    <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                </DataTrigger>
                                            </material:ButtonView.Triggers>
                                        </material:ButtonView>
                                    </DataTemplate>
                                </material:TabItem.HeaderTemplate>
                                <material:TabItem.Content>
                                    <local:BodyMapControl
                                        BaseVisitId="{Binding BaseVisitId}"
                                        BodyMapList="{Binding BodyMapList, Mode=TwoWay}"
                                        IsReadOnly="{Binding IsReadOnly}"
                                        Type="{Binding TypeName}"
                                        TypeId="{Binding VisitTask.Id}" />
                                </material:TabItem.Content>
                            </material:TabItem>
                        </material:TabView>
                    </Border>
                </VerticalStackLayout>
            </input:FormView>
        </ScrollView>

        <input:FormView
            Grid.Row="1"
            Margin="10,0"
            IsVisible="{Binding IsNotBusy}"
            Spacing="10"
            SubmitCommand="{Binding SubmitCommand}"
            VerticalOptions="Fill">
            <material:ButtonView
                Grid.Row="1"
                input:FormView.IsSubmitButton="True"
                AutomationId="SaveButton"
                IsEnabled="{Binding IsNotBusy}"
                IsVisible="{Binding IsNotReadOnly}"
                Style="{StaticResource CentralizedButtonViewStyle}">
                <Grid>
                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        IsVisible="{Binding IsNotBusy}"
                        Spacing="10">
                        <Label Style="{StaticResource CentralizedPrimaryBtnLabelStyle}" Text="SAVE" />
                    </HorizontalStackLayout>

                    <local:CustomActivityIndicator
                        BusyText="Saving..."
                        IsBusy="{Binding IsBusy}"
                        SourceFile="LoaderWhite.json"
                        Style="{StaticResource CentralizedActivityIndicatorStyle}" />
                </Grid>
            </material:ButtonView>
        </input:FormView>

        <local:CustomActivityIndicator IsBusy="{Binding IsBusy}" />
    </Grid>
</local:BaseContentPage>