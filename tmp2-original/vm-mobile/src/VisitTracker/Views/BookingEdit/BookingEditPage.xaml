<?xml version="1.0" encoding="utf-8" ?>
<local:BaseContentPage
    x:Class="VisitTracker.BookingEditPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:domain="clr-namespace:VisitTracker.Domain;assembly=VisitTracker.Domain"
    xmlns:input="clr-namespace:InputKit.Shared.Controls;assembly=InputKit.Maui"
    xmlns:local="clr-namespace:VisitTracker"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
    xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
    xmlns:validation="clr-namespace:InputKit.Shared.Validations;assembly=InputKit.Maui"
    x:Name="this"
    Title="{Binding Title}"
    x:DataType="local:BookingEditVm"
    x:TypeArguments="local:BookingEditVm"
    AutomationId="BookingEditPage"
    BackgroundColor="{StaticResource MainBackgroudColor}"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False">
    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding OnBackCommand}" />
    </Shell.BackButtonBehavior>

    <Grid Margin="0,10">
        <ScrollView
            HorizontalOptions="Fill"
            IsVisible="{Binding IsNotBusy}"
            VerticalOptions="Fill">

            <input:FormView
                IsVisible="{Binding IsNotBusy}"
                Spacing="15"
                Style="{StaticResource CardsMarginStyle}"
                SubmitCommand="{Binding SubmitCommand}"
                VerticalOptions="Start">
                <VerticalStackLayout Spacing="5">
                    <HorizontalStackLayout Margin="0,5" Spacing="8">
                        <local:EmergencyButtonControl AutomationId="EmergencyButton" />
                        <local:CallOfficeButtonControl AutomationId="CallOfficeButton" />
                        <local:IncidentReportButtonControl
                            AutomationId="IncidentReportButton"
                            BaseVisitId="{Binding OngoingDto.Visit.Id}"
                            ServiceUserId="{Binding OngoingDto.Booking.ServiceUserId}" />
                    </HorizontalStackLayout>

                    <local:CardViewControl HasCardTitle="False" VerticalOptions="Center">
                        <local:UserCardControl
                            AutomationId="ServiceUserCard"
                            IsAccessInstructionsVisible="True"
                            IsCallVisible="True"
                            IsDirectionVisible="True"
                            User="{Binding OngoingDto.ServiceUserCard}" />
                    </local:CardViewControl>

                    <uranium:ExpanderView>
                        <uranium:ExpanderView.Header>
                            <Label Style="{StaticResource Heading1Style}" Text="Booking Notes" />
                        </uranium:ExpanderView.Header>
                        <local:CardViewControl HasCardTitle="False">
                            <Grid Padding="3">
                                <Label
                                    Padding="2"
                                    FontSize="14"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Start"
                                    IsVisible="{Binding OngoingDto.Notes, Converter={x:StaticResource IsStringNotNullOrEmptyConverter}}"
                                    LineBreakMode="WordWrap"
                                    Text="{Binding OngoingDto.Notes}"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center"
                                    VerticalTextAlignment="Center" />
                                <Label
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding OngoingDto.Notes, Converter={x:StaticResource IsStringNullOrEmptyConverter}}"
                                    Style="{StaticResource MutedTextStyles}"
                                    Text="Not Available!" />
                            </Grid>
                        </local:CardViewControl>
                    </uranium:ExpanderView>

                    <!--<local:CardViewControl CardTitle="Hand-over Notes (from last visit)">
                        <Grid Padding="3" RowDefinitions="Auto,Auto">
                            <Grid IsVisible="{Binding ShowHandOverNotesButton, Converter={StaticResource NotConverter}}">
                                <Label
                                    Padding="2"
                                    FontSize="14"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Start"
                                    IsVisible="{Binding OngoingDto.HandOverNotes, Converter={x:StaticResource IsStringNotNullOrEmptyConverter}}"
                                    LineBreakMode="WordWrap"
                                    Text="{Binding OngoingDto.HandOverNotes}"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center"
                                    VerticalTextAlignment="Center" />
                                <Label
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding OngoingDto.HandOverNotes, Converter={x:StaticResource IsStringNullOrEmptyConverter}}"
                                    Style="{StaticResource MutedTextStyles}"
                                    Text="Not Available!" />
                            </Grid>

                            <Button
                                Grid.Row="1"
                                Command="{Binding DownloadHandOverNotesCommand}"
                                IsVisible="{Binding ShowHandOverNotesButton}"
                                Style="{StaticResource PostSubmitButtonStyle}"
                                Text="Download Hand Over Notes" />
                        </Grid>
                    </local:CardViewControl>-->

                    <uranium:ExpanderView IsExpanded="{Binding IsHandOverNotesExpanded, Mode=TwoWay}">
                        <uranium:ExpanderView.Header>
                            <Label Style="{StaticResource Heading1Style}" Text="Hand-over Notes (last visit)" />
                        </uranium:ExpanderView.Header>
                        <local:CardViewControl HasCardTitle="False">
                            <Grid Padding="3">
                                <Label
                                    Padding="2"
                                    FontSize="14"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Start"
                                    IsVisible="{Binding OngoingDto.HandOverNotes, Converter={x:StaticResource IsStringNotNullOrEmptyConverter}}"
                                    LineBreakMode="WordWrap"
                                    Text="{Binding OngoingDto.HandOverNotes}"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center"
                                    VerticalTextAlignment="Center" />
                                <Label
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding OngoingDto.HandOverNotes, Converter={x:StaticResource IsStringNullOrEmptyConverter}}"
                                    LineBreakMode="WordWrap"
                                    Style="{StaticResource MutedTextStyles}"
                                    Text="Not Available!" />
                            </Grid>
                        </local:CardViewControl>
                    </uranium:ExpanderView>

                    <VerticalStackLayout>
                        <Label
                            AutomationId="TaskLabel"
                            Style="{StaticResource Heading1Style}"
                            Text="General Tasks" />
                        <VerticalStackLayout
                            BindableLayout.ItemsSource="{Binding OngoingDto.TaskList, Mode=TwoWay}"
                            IsVisible="{Binding OngoingDto.TaskList, Converter={StaticResource IsListNotNullOrEmptyConverter}}"
                            Spacing="10">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="{x:Type local:TaskDto}">
                                    <material:ButtonView
                                        Padding="5"
                                        AutomationId="TaskButton"
                                        BackgroundColor="{StaticResource PanelColor}"
                                        CommandParameter="{Binding Id}"
                                        StrokeShape="{RoundRectangle CornerRadius=5}"
                                        Style="{StaticResource CardVisualStateGroup}"
                                        TappedCommand="{Binding BindingContext.OpenTaskCommand, Source={x:Reference this}}">
                                        <Grid
                                            Padding="3"
                                            ColumnDefinitions="Auto,*,Auto"
                                            ColumnSpacing="5">
                                            <Label
                                                Grid.Column="0"
                                                FontFamily="MaterialCommunityIcons"
                                                FontSize="18"
                                                HorizontalOptions="End"
                                                Opacity="0.5"
                                                Text="{x:Static local:MaterialCommunityIconsFont.CheckboxBlankCircle}"
                                                TextColor="{Binding CompletionStatusColor}"
                                                VerticalOptions="Center"
                                                VerticalTextAlignment="Center" />

                                            <Label
                                                Grid.Column="1"
                                                Padding="2"
                                                FontSize="14"
                                                HorizontalOptions="Fill"
                                                HorizontalTextAlignment="Start"
                                                LineBreakMode="TailTruncation"
                                                MaxLines="2"
                                                Text="{Binding Title}"
                                                TextColor="{StaticResource TextColor}"
                                                VerticalOptions="Center"
                                                VerticalTextAlignment="Center" />

                                            <Grid
                                                Grid.Column="2"
                                                Padding="0"
                                                RowDefinitions="*,Auto"
                                                VerticalOptions="Center">

                                                <Label
                                                    Grid.Row="0"
                                                    FontFamily="MaterialCommunityIcons"
                                                    FontSize="18"
                                                    HorizontalOptions="Fill"
                                                    HorizontalTextAlignment="End"
                                                    Text="{x:Static local:MaterialCommunityIconsFont.ArrowRight}"
                                                    TextColor="{Binding CompletionStatusColor, Mode=TwoWay}"
                                                    VerticalOptions="Fill"
                                                    VerticalTextAlignment="Center" />

                                                <Label
                                                    Grid.Row="1"
                                                    Padding="2"
                                                    FontSize="15"
                                                    HorizontalOptions="Fill"
                                                    HorizontalTextAlignment="End"
                                                    IsVisible="{Binding CompletedOn, Converter={StaticResource IsNotNullConverter}}"
                                                    Text="{Binding CompletedOn, Mode=TwoWay, StringFormat='{0:hh:mm} hrs'}"
                                                    TextColor="{Binding CompletionStatusColor, Mode=TwoWay}"
                                                    VerticalOptions="Center"
                                                    VerticalTextAlignment="Center" />
                                            </Grid>
                                        </Grid>
                                    </material:ButtonView>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>

                        <local:CardViewControl HasCardTitle="False" IsVisible="{Binding OngoingDto.TaskList, Converter={StaticResource IsListNullOrEmptyConverter}}">
                            <Label
                                Margin="10,5"
                                HorizontalTextAlignment="Center"
                                IsVisible="{Binding OngoingDto.TaskList, Converter={StaticResource IsListNullOrEmptyConverter}}"
                                Style="{DynamicResource MutedTextStyles}"
                                Text="No tasks found!"
                                VerticalTextAlignment="Center" />
                        </local:CardViewControl>
                    </VerticalStackLayout>

                    <VerticalStackLayout>
                        <VerticalStackLayout.IsVisible>
                            <MultiBinding Converter="{StaticResource AllValueTrueConverter}">
                                <Binding Path="OngoingDto.IsFluidApplicable" />
                                <Binding Converter="{StaticResource IsNotNullConverter}" Path="OngoingDto.Fluid" />
                            </MultiBinding>
                        </VerticalStackLayout.IsVisible>
                        <Label
                            AutomationId="FluidLabel"
                            Style="{StaticResource Heading1Style}"
                            Text="Fluids" />

                        <material:ButtonView
                            Padding="5"
                            AutomationId="FluidButton"
                            BackgroundColor="{StaticResource PanelColor}"
                            CommandParameter="{Binding OngoingDto.Fluid.Id}"
                            StrokeShape="{RoundRectangle CornerRadius=5}"
                            Style="{StaticResource CardVisualStateGroup}"
                            TappedCommand="{Binding OpenFluidDetailCommand}">
                            <Grid
                                Padding="3"
                                ColumnDefinitions="Auto,*,Auto"
                                ColumnSpacing="5">
                                <Label
                                    Grid.Column="0"
                                    FontFamily="MaterialCommunityIcons"
                                    FontSize="18"
                                    HorizontalOptions="End"
                                    Opacity="0.5"
                                    Text="{x:Static local:MaterialCommunityIconsFont.CheckboxBlankCircle}"
                                    TextColor="{Binding OngoingDto.Fluid.CompletionStatusColor}"
                                    VerticalOptions="Center"
                                    VerticalTextAlignment="Center" />

                                <Label
                                    Grid.Column="1"
                                    Padding="2"
                                    FontSize="14"
                                    HorizontalOptions="Fill"
                                    HorizontalTextAlignment="Start"
                                    LineBreakMode="TailTruncation"
                                    MaxLines="2"
                                    Text="Record fluid balance"
                                    TextColor="{StaticResource TextColor}"
                                    VerticalOptions="Center"
                                    VerticalTextAlignment="Center" />

                                <Grid
                                    Grid.Column="2"
                                    Padding="0"
                                    RowDefinitions="*,Auto"
                                    VerticalOptions="Center">

                                    <Label
                                        Grid.Row="0"
                                        FontFamily="MaterialCommunityIcons"
                                        FontSize="18"
                                        HorizontalOptions="Fill"
                                        HorizontalTextAlignment="End"
                                        Text="{x:Static local:MaterialCommunityIconsFont.ArrowRight}"
                                        TextColor="{Binding OngoingDto.Fluid.CompletionStatusColor, Mode=TwoWay}"
                                        VerticalOptions="Fill"
                                        VerticalTextAlignment="Center" />

                                    <Label
                                        Grid.Row="1"
                                        Padding="2"
                                        FontSize="15"
                                        HorizontalOptions="Fill"
                                        HorizontalTextAlignment="End"
                                        IsVisible="{Binding OngoingDto.Fluid.CompletedOn, Converter={StaticResource IsNotNullConverter}}"
                                        Text="{Binding OngoingDto.Fluid.CompletedOn, Mode=TwoWay, StringFormat='{0:hh:mm} hrs'}"
                                        TextColor="{Binding OngoingDto.Fluid.CompletionStatusColor, Mode=TwoWay}"
                                        VerticalOptions="Center"
                                        VerticalTextAlignment="Center" />
                                </Grid>
                            </Grid>
                        </material:ButtonView>
                    </VerticalStackLayout>

                    <VerticalStackLayout>
                        <Label
                            AutomationId="MedicationLabel"
                            Style="{StaticResource Heading1Style}"
                            Text="Medications" />

                        <VerticalStackLayout
                            BindableLayout.ItemsSource="{Binding OngoingDto.MedicationList, Mode=TwoWay}"
                            IsVisible="{Binding OngoingDto.MedicationList, Converter={StaticResource IsListNotNullOrEmptyConverter}}"
                            Spacing="10">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="{x:Type local:MedicationDto}">
                                    <material:ButtonView
                                        Padding="5"
                                        AutomationId="MedicationButton"
                                        BackgroundColor="{StaticResource PanelColor}"
                                        CommandParameter="{Binding Id}"
                                        StrokeShape="{RoundRectangle CornerRadius=5}"
                                        TappedCommand="{Binding BindingContext.OpenMedicationCommand, Source={x:Reference this}}">

                                        <Grid
                                            Padding="3"
                                            ColumnDefinitions="Auto,*,Auto"
                                            ColumnSpacing="5">
                                            <Label
                                                Grid.Column="0"
                                                FontFamily="MaterialCommunityIcons"
                                                FontSize="16"
                                                HorizontalOptions="End"
                                                Opacity="0.7"
                                                Text="{x:Static local:MaterialCommunityIconsFont.CheckboxBlankCircle}"
                                                TextColor="{Binding CompletionStatusColor}"
                                                VerticalOptions="Center"
                                                VerticalTextAlignment="Center" />

                                            <Label
                                                Grid.Column="1"
                                                Padding="2"
                                                FontSize="14"
                                                HorizontalOptions="Fill"
                                                HorizontalTextAlignment="Start"
                                                LineBreakMode="TailTruncation"
                                                MaxLines="2"
                                                Text="{Binding Name, Mode=TwoWay}"
                                                TextColor="{StaticResource TextColor}"
                                                VerticalOptions="Center"
                                                VerticalTextAlignment="Center">
                                                <Label.Triggers>
                                                    <DataTrigger
                                                        Binding="{Binding AdminsterWarning, Converter={StaticResource NotConverter}}"
                                                        TargetType="Label"
                                                        Value="False">
                                                        <DataTrigger.EnterActions>
                                                            <local:BlinkTriggerAction />
                                                        </DataTrigger.EnterActions>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>

                                            <Grid
                                                Grid.Column="2"
                                                Padding="0"
                                                RowDefinitions="*,Auto"
                                                VerticalOptions="Center">
                                                <Label
                                                    Grid.Row="0"
                                                    FontFamily="MaterialCommunityIcons"
                                                    FontSize="18"
                                                    HorizontalOptions="Fill"
                                                    HorizontalTextAlignment="End"
                                                    Text="{x:Static local:MaterialCommunityIconsFont.ArrowRight}"
                                                    TextColor="{Binding CompletionStatusColor, Mode=TwoWay}"
                                                    VerticalOptions="Fill"
                                                    VerticalTextAlignment="Center" />
                                                <Label
                                                    Grid.Row="1"
                                                    Padding="2"
                                                    FontSize="15"
                                                    HorizontalOptions="Fill"
                                                    HorizontalTextAlignment="End"
                                                    IsVisible="{Binding CompletedOn, Converter={StaticResource IsNotNullConverter}}"
                                                    Text="{Binding CompletedOn, Mode=TwoWay, StringFormat='{0:hh:mm} hrs'}"
                                                    TextColor="{Binding CompletionStatusColor, Mode=TwoWay}"
                                                    VerticalOptions="Center"
                                                    VerticalTextAlignment="Center" />
                                            </Grid>
                                        </Grid>
                                    </material:ButtonView>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>

                        <local:CardViewControl HasCardTitle="False" IsVisible="{Binding OngoingDto.MedicationList, Converter={StaticResource IsListNullOrEmptyConverter}}">
                            <Label
                                Margin="10,5"
                                AutomationId="NoMedicationLabel"
                                HorizontalTextAlignment="Center"
                                Style="{StaticResource MutedTextStyles}"
                                Text="No medications found!"
                                VerticalTextAlignment="Center" />
                        </local:CardViewControl>
                    </VerticalStackLayout>

                    <local:IncidentReportControl
                        AutomationId="IncidentReportControl"
                        BaseVisitId="{Binding OngoingDto.Visit.Id}"
                        IncidentReportList="{Binding OngoingDto.IncidentList}"
                        IsReadOnly="{Binding IsReadOnly}"
                        IsVisible="{Binding OngoingDto.IncidentList, Converter={StaticResource IsListNotNullOrEmptyConverter}}"
                        ServiceUserId="{Binding OngoingDto.Booking.ServiceUserId}" />

                    <VerticalStackLayout Spacing="5">
                        <Label
                            AutomationId="VisitSummaryLabel"
                            Style="{StaticResource Heading1Style}"
                            Text="Visit Summary" />

                        <local:CustomMultiPickerControl
                            Title="Short Remarks *"
                            AutomationId="ShortRemarks"
                            ItemsSource="{Binding OngoingDto.ShortRemarks}"
                            SelectedItems="{Binding OngoingDto.SelectedShortRemarks, Mode=TwoWay}"
                            Style="{StaticResource PickerFieldStyle}">
                            <local:CustomMultiPickerControl.Validations>
                                <validation:RequiredValidation Message="* required" />
                            </local:CustomMultiPickerControl.Validations>
                        </local:CustomMultiPickerControl>

                        <material:EditorField
                            Title="Additional Notes"
                            MaxLength="2000"
                            Style="{StaticResource PickerFieldStyle}"
                            Text="{Binding OngoingDto.Summary}" />

                        <local:CustomMultiPickerControl
                            Title="Health Status *"
                            AutomationId="HealthStatus"
                            ItemsSource="{Binding OngoingDto.HealthStatuses}"
                            SelectedItems="{Binding OngoingDto.SelectedHealthStatuses, Mode=TwoWay}"
                            Style="{StaticResource PickerFieldStyle}">
                            <local:CustomMultiPickerControl.Validations>
                                <validation:RequiredValidation Message="* required" />
                            </local:CustomMultiPickerControl.Validations>
                        </local:CustomMultiPickerControl>

                        <material:EditorField
                            Title="Hand-over Notes (next visit)"
                            IsSpellCheckEnabled="True"
                            IsTextPredictionEnabled="True"
                            MaxLength="2000"
                            Style="{StaticResource PickerFieldStyle}"
                            Text="{Binding OngoingDto.HandOverNotesEntered}" />

                        <Border
                            Margin="0,5"
                            Padding="8"
                            Stroke="{StaticResource PanelBorderColor}"
                            StrokeShape="{RoundRectangle CornerRadius=10}">
                            <material:TabView>
                                <material:TabItem Title="Attachments">
                                    <material:TabItem.HeaderTemplate>
                                        <DataTemplate>
                                            <material:ButtonView TappedCommand="{Binding Command}">
                                                <Label
                                                    FontFamily="14"
                                                    HorizontalOptions="Center"
                                                    Text="Attachments"
                                                    TextColor="{StaticResource TextColor}" />
                                                <material:ButtonView.Triggers>
                                                    <DataTrigger
                                                        Binding="{Binding IsSelected}"
                                                        TargetType="material:ButtonView"
                                                        Value="True">
                                                        <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                    </DataTrigger>
                                                    <DataTrigger
                                                        Binding="{Binding IsSelected}"
                                                        TargetType="material:ButtonView"
                                                        Value="False">
                                                        <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                    </DataTrigger>
                                                </material:ButtonView.Triggers>
                                            </material:ButtonView>
                                        </DataTemplate>
                                    </material:TabItem.HeaderTemplate>
                                    <material:TabItem.Content>
                                        <local:AttachmentControl
                                            Padding="5"
                                            AttachmentList="{Binding OngoingDto.AttachmentList}"
                                            BaseVisitId="{Binding OngoingDto.Visit.Id}"
                                            IsReadOnly="{Binding IsReadOnly}"
                                            MaxAudios="3"
                                            MaxImages="3"
                                            Type="{Binding TypeName}"
                                            TypeId="{Binding OngoingDto.Visit.Id}" />
                                    </material:TabItem.Content>
                                </material:TabItem>

                                <material:TabItem Title="Body Maps">
                                    <material:TabItem.HeaderTemplate>
                                        <DataTemplate>
                                            <material:ButtonView AutomationId="BodyMapTabButton" TappedCommand="{Binding Command}">
                                                <Label
                                                    FontFamily="14"
                                                    HorizontalOptions="Center"
                                                    Text="Body Maps"
                                                    TextColor="{StaticResource TextColor}"
                                                    VerticalOptions="Center" />
                                                <material:ButtonView.Triggers>
                                                    <DataTrigger
                                                        Binding="{Binding IsSelected}"
                                                        TargetType="material:ButtonView"
                                                        Value="True">
                                                        <Setter Property="Style" Value="{StaticResource TabSelectedButtonStyle}" />
                                                    </DataTrigger>
                                                    <DataTrigger
                                                        Binding="{Binding IsSelected}"
                                                        TargetType="material:ButtonView"
                                                        Value="False">
                                                        <Setter Property="Style" Value="{StaticResource TabUnselectedButtonStyle}" />
                                                    </DataTrigger>
                                                </material:ButtonView.Triggers>
                                            </material:ButtonView>
                                        </DataTemplate>
                                    </material:TabItem.HeaderTemplate>
                                    <material:TabItem.Content>
                                        <local:BodyMapControl
                                            BaseVisitId="{Binding OngoingDto.Visit.Id}"
                                            BodyMapList="{Binding OngoingDto.BodyMapList}"
                                            IsReadOnly="{Binding IsReadOnly}"
                                            Type="{Binding TypeName}"
                                            TypeId="{Binding OngoingDto.Visit.Id}" />
                                    </material:TabItem.Content>
                                </material:TabItem>
                            </material:TabView>
                        </Border>
                    </VerticalStackLayout>

                    <VerticalStackLayout>
                        <Label
                            AutomationId="ConsumableLabel"
                            Style="{StaticResource Heading1Style}"
                            Text="Consumables Used" />

                        <CollectionView
                            HorizontalOptions="Fill"
                            IsVisible="{Binding OngoingDto.ConsumableList, Converter={StaticResource IsListNotNullOrEmptyConverter}}"
                            ItemsSource="{Binding OngoingDto.ConsumableList}"
                            VerticalOptions="Fill">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout
                                    HorizontalItemSpacing="5"
                                    Orientation="Vertical"
                                    Span="2"
                                    VerticalItemSpacing="5" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="{x:Type local:VisitConsumableDto}">
                                    <material:TextField
                                        Title="{Binding ConsumableTypeStr}"
                                        Grid.Column="0"
                                        AutomationId="ConsumableUsed"
                                        InputBackgroundColor="{StaticResource FrameBackgroundColor}"
                                        IsEnabled="{Binding OngoingDto.IsMaster, Source={x:Reference this}}"
                                        Keyboard="Numeric"
                                        MaxLength="2"
                                        Style="{StaticResource PickerFieldStyle}"
                                        Text="{Binding QuantityUsed, Mode=TwoWay}" />
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <material:ButtonView
                        input:FormView.IsSubmitButton="True"
                        AutomationId="SubmitButton"
                        IsEnabled="{Binding IsNotBusy}"
                        IsVisible="{Binding IsNotReadOnly}"
                        Style="{StaticResource CentralizedButtonViewStyle}">
                        <Grid>
                            <HorizontalStackLayout
                                HorizontalOptions="Center"
                                IsVisible="{Binding IsNotBusy}"
                                Spacing="10">
                                <Label Style="{StaticResource CentralizedPrimaryBtnLabelStyle}" Text="UPLOAD VISIT REPORT" />
                            </HorizontalStackLayout>

                            <local:CustomActivityIndicator
                                BusyText="Uploading..."
                                IsBusy="{Binding IsBusy}"
                                SourceFile="LoaderWhite.json"
                                Style="{StaticResource CentralizedActivityIndicatorStyle}" />
                        </Grid>
                    </material:ButtonView>
                </VerticalStackLayout>
            </input:FormView>
        </ScrollView>

        <local:CustomActivityIndicator IsBusy="{Binding IsBusy}" />
    </Grid>
</local:BaseContentPage>